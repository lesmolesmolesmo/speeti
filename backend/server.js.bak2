// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

require('dotenv').config({ path: __dirname + '/.env' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const express = require('express');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const cors = require('cors');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const http = require('http');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const { Server } = require('socket.io');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const path = require('path');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const fs = require('fs');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const bcrypt = require('bcryptjs');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const jwt = require('jsonwebtoken');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const { generateInvoice, generateInvoiceNumber } = require('./invoice-generator');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const emailService = require('./email-service');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const sharp = require("sharp");
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const crypto = require("crypto");
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const rateLimit = require('express-rate-limit');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Rate limiters
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const generalLimiter = rateLimit({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  windowMs: 15 * 60 * 1000, // 15 minutes
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  max: 200, // 200 requests per window
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  message: { error: 'Zu viele Anfragen. Bitte warte einen Moment.' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  standardHeaders: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  legacyHeaders: false,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const authLimiter = rateLimit({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  windowMs: 15 * 60 * 1000, // 15 minutes
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  max: 30, // 30 login/register attempts
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  message: { error: 'Zu viele Anmeldeversuche. Bitte warte 15 Minuten.' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  standardHeaders: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  legacyHeaders: false,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const strictLimiter = rateLimit({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  windowMs: 60 * 1000, // 1 minute
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  max: 5, // 5 requests per minute for sensitive endpoints
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  message: { error: 'Rate limit erreicht. Bitte warte.' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Helper function to send order emails (Resend)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

async function sendOrderEmails(orderId, status) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT o.*, o.order_number, o.track_token, u.email, u.name as customer_name, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

             a.street, a.house_number, a.postal_code, a.city
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM orders o
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN users u ON o.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      LEFT JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE o.id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).get(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!order || !order.email) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('âš ï¸ No email for order', orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT oi.*, p.name, p.image FROM order_items oi
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN products p ON oi.product_id = p.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE oi.order_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).all(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const orderData = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      order_number: order.order_number || ('SPT-' + orderId),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      track_token: order.track_token,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      total: order.total,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      address: `${order.street} ${order.house_number}, ${order.postal_code} ${order.city}`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const customer = { email: order.email, name: order.customer_name };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Map internal statuses to email statuses
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const emailStatus = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'confirmed': 'confirmed',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'picking': 'preparing',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'picked': 'preparing', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'delivering': 'delivering',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'delivered': 'delivered'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (status === 'confirmed') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      await emailService.sendOrderConfirmation(orderData, customer, items);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('ðŸ“§ Order confirmation sent to:', order.email);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } else if (emailStatus[status]) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      await emailService.sendStatusUpdate(orderData, customer, emailStatus[status]);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('ðŸ“§ Status update (' + status + ') sent to:', order.email);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('âŒ Email error:', e.message);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const app = express();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.set("trust proxy", 1);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const server = http.createServer(app);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const io = new Server(server, {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  cors: { origin: '*' }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Database setup
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const Database = require('better-sqlite3');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const db = new Database(path.join(__dirname, 'speeti.db'));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Initialize database
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

db.exec(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Users (customers, drivers, admins)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS users (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    email TEXT UNIQUE NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    password TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    name TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    phone TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    role TEXT DEFAULT 'customer',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    avatar TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Addresses
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS addresses (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    label TEXT DEFAULT 'Zuhause',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    street TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    house_number TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    postal_code TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    city TEXT DEFAULT 'MÃ¼nster',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    instructions TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    is_default INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    lat REAL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    lng REAL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Categories
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS categories (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    name TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    slug TEXT UNIQUE NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    icon TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    image TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    color TEXT DEFAULT '#14B8A6',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sort_order INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    active INTEGER DEFAULT 1
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS products (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    category_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    name TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    description TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    price REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    original_price REAL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    image TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    unit TEXT DEFAULT 'StÃ¼ck',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    unit_amount TEXT DEFAULT '1',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    in_stock INTEGER DEFAULT 1,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    stock_count INTEGER DEFAULT 100,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    featured INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sort_order INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (category_id) REFERENCES categories(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Orders
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS orders (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    address_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    driver_id INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    status TEXT DEFAULT 'pending',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    subtotal REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    delivery_fee REAL DEFAULT 2.99,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    total REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    payment_method TEXT DEFAULT 'cash',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    payment_status TEXT DEFAULT 'pending',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    stripe_session_id TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    notes TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    estimated_delivery TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    picked_at DATETIME,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    delivered_at DATETIME,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (address_id) REFERENCES addresses(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (driver_id) REFERENCES users(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Order Items
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS order_items (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    product_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    quantity INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    price REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    picked INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (order_id) REFERENCES orders(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (product_id) REFERENCES products(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Order Chat Messages (Driver <-> Customer)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS messages (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sender_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    message TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (order_id) REFERENCES orders(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (sender_id) REFERENCES users(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Support Tickets (AI Chat + Escalation)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS support_tickets (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    status TEXT DEFAULT 'open',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    escalated INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    escalation_reason TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    assigned_to INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    resolved_at DATETIME,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (order_id) REFERENCES orders(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (assigned_to) REFERENCES users(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Support Chat Messages (AI + Human)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS support_messages (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ticket_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sender_type TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sender_id INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    message TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (ticket_id) REFERENCES support_tickets(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Store Settings
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS settings (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    key TEXT PRIMARY KEY,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    value TEXT
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Invoices
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS invoices (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id INTEGER NOT NULL UNIQUE,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    invoice_number TEXT NOT NULL UNIQUE,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    invoice_date DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    net_total REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    tax_7_amount REAL DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    tax_19_amount REAL DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    gross_total REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    pdf_path TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sent_at DATETIME,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (order_id) REFERENCES orders(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Business Settings (for invoices)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS business_settings (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY CHECK (id = 1),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    company_name TEXT DEFAULT 'Speeti GmbH',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    street TEXT DEFAULT 'MusterstraÃŸe 1',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    postal_code TEXT DEFAULT '48149',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    city TEXT DEFAULT 'MÃ¼nster',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    country TEXT DEFAULT 'Deutschland',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    phone TEXT DEFAULT '+49 251 12345678',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    email TEXT DEFAULT 'info@speeti.de',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    website TEXT DEFAULT 'www.speeti.de',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    tax_number TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    vat_id TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    registry TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    bank_name TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    iban TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    bic TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    logo_url TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Initialize business settings if empty
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  INSERT OR IGNORE INTO business_settings (id) VALUES (1);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Promo Codes
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS promo_codes (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    code TEXT UNIQUE NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    description TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    discount_type TEXT DEFAULT 'percent',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    discount_value REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    min_order_value REAL DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    max_uses INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    used_count INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    valid_from DATETIME,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    valid_until DATETIME,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    active INTEGER DEFAULT 1,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Promo Code Usage (track per user)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS promo_usage (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    promo_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    discount_amount REAL NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    used_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (promo_id) REFERENCES promo_codes(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (order_id) REFERENCES orders(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    UNIQUE(promo_id, user_id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Ratings (Customer rates Driver)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS ratings (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id INTEGER UNIQUE NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    driver_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    comment TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (order_id) REFERENCES orders(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (driver_id) REFERENCES users(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Push Subscriptions
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS push_subscriptions (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    endpoint TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    p256dh TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    auth TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    UNIQUE(user_id, endpoint)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Add sample promo codes
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  INSERT OR IGNORE INTO promo_codes (code, description, discount_type, discount_value, min_order_value) 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  VALUES 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ('WELCOME10', 'Willkommensrabatt 10%', 'percent', 10, 15),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ('SPEETI5', '5â‚¬ Rabatt', 'fixed', 5, 20),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ('FREEDELIVERY', 'Kostenlose Lieferung', 'delivery', 100, 10);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Inventory Management (Warehouse)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS inventory (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    barcode TEXT UNIQUE,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    name TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    brand TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    category TEXT DEFAULT 'Sonstiges',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    price REAL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    image TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    stock INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    min_stock INTEGER DEFAULT 5,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    source TEXT DEFAULT 'Manual',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    product_id INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (product_id) REFERENCES products(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  -- Inventory Transactions (for history/audit)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS inventory_transactions (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    inventory_id INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    change_amount INTEGER NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    type TEXT DEFAULT 'adjustment',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    reason TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    user_id INTEGER,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (inventory_id) REFERENCES inventory(id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FOREIGN KEY (user_id) REFERENCES users(id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Add new columns if they don't exist (for existing databases)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.exec(`ALTER TABLE orders ADD COLUMN payment_status TEXT DEFAULT 'pending'`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

} catch(e) {}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.exec(`ALTER TABLE orders ADD COLUMN stripe_session_id TEXT`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

try { db.exec(`ALTER TABLE orders ADD COLUMN cancelled_at DATETIME`); } catch (e) {}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

try { db.exec(`ALTER TABLE orders ADD COLUMN cancel_reason TEXT`); } catch (e) {}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

} catch(e) {}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const JWT_SECRET = process.env.JWT_SECRET || 'speeti-secret-key-2024';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Generate order details
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

function generateOrderDetails() {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const crypto = require("crypto");
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get next order ID for sequential numbering
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const maxRow = db.prepare("SELECT MAX(id) as maxId FROM orders").get();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const nextId = (maxRow?.maxId || 0) + 1;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderNumber = "SPT-" + String(nextId).padStart(5, '0');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const trackToken = crypto.randomBytes(16).toString("hex");
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  return { orderNumber, trackToken };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const PORT = process.env.PORT || 3000;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const OPENAI_API_KEY = process.env.OPENAI_API_KEY || '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY || '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const STRIPE_WEBHOOK_SECRET = process.env.STRIPE_WEBHOOK_SECRET || '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Middleware
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.use(cors({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  origin: ['https://speeti.de', 'http://localhost:5173', 'http://localhost:3000'],
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  credentials: true
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.use(express.json());
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.use('/api', generalLimiter);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Serve frontend in production
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Static files with cache headers for SPA
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.use(express.static(path.join(__dirname, '../frontend/dist'), {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  maxAge: '1d',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  setHeaders: (res, filePath) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (filePath.endsWith('.html')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } else if (filePath.match(/\.(js|css)$/)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Auth middleware
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const auth = (roles = []) => (req, res, next) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const token = req.headers.authorization?.split(' ')[1];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!token) return res.status(401).json({ error: 'Nicht autorisiert' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const decoded = jwt.verify(token, JWT_SECRET);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    req.user = decoded;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (roles.length && !roles.includes(decoded.role)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(403).json({ error: 'Keine Berechtigung' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    next();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(401).json({ error: 'Token ungÃ¼ltig' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ AUTH ROUTES ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/auth/register', authLimiter, async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { email, password, name, phone } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Password validation
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!password || password.length < 8) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Passwort muss mindestens 8 Zeichen haben' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const hash = await bcrypt.hash(password, 10);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const stmt = db.prepare('INSERT INTO users (email, password, name, phone) VALUES (?, ?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = stmt.run(email, hash, name, phone || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const token = jwt.sign({ id: result.lastInsertRowid, email, name, role: 'customer' }, JWT_SECRET, { expiresIn: '7d' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ token, user: { id: result.lastInsertRowid, email, name, role: 'customer' } });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(400).json({ error: 'Email bereits registriert' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/auth/login', authLimiter, async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { email, password } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const user = db.prepare('SELECT * FROM users WHERE email = ?').get(email);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!user) return res.status(401).json({ error: 'UngÃ¼ltige Anmeldedaten' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const valid = await bcrypt.compare(password, user.password);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!valid) return res.status(401).json({ error: 'UngÃ¼ltige Anmeldedaten' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const token = jwt.sign({ id: user.id, email: user.email, name: user.name, role: user.role }, JWT_SECRET, { expiresIn: '7d' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ token, user: { id: user.id, email: user.email, name: user.name, role: user.role, phone: user.phone } });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/auth/me', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const user = db.prepare('SELECT id, email, name, phone, role, avatar FROM users WHERE id = ?').get(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(user);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ PASSWORD RESET ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Request password reset
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/auth/forgot-password', strictLimiter, async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { email } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!email) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'E-Mail erforderlich' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Always return success (don't reveal if email exists)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true, message: 'Falls ein Konto mit dieser E-Mail existiert, erhÃ¤ltst du einen Link zum ZurÃ¼cksetzen.' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const user = db.prepare('SELECT id, name, email FROM users WHERE email = ?').get(email.toLowerCase());
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!user) return;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Generate reset token (valid 1 hour)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const crypto = require('crypto');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const token = crypto.randomBytes(32).toString('hex');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const expires = Date.now() + 3600000; // 1 hour
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Store token
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE users SET reset_token = ?, reset_expires = ? WHERE id = ?').run(token, expires, user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Send email
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const resetUrl = 'https://speeti.de/reset-password?token=' + token;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    await emailService.sendEmail(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      user.email,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'ðŸ” Passwort zurÃ¼cksetzen',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      emailService.emailTemplate(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <div style="text-align:center;padding:24px 0;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <div style="font-size:64px;margin-bottom:16px;">ðŸ”</div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <h1 style="color:#1f2937;margin:0 0 8px 0;">Passwort zurÃ¼cksetzen</h1>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <p style="color:#6b7280;margin:0;">Du hast angefordert, dein Passwort zurÃ¼ckzusetzen.</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <p style="color:#374151;">Hallo <strong>${user.name || 'du'}</strong>!</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <p style="color:#374151;">Klicke auf den Button um ein neues Passwort zu wÃ¤hlen:</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <div style="text-align:center;margin:30px 0;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <a href="${resetUrl}" class="button">Neues Passwort setzen</a>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <div class="info-box">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <p style="margin:0;color:#6b7280;font-size:14px;">â±ï¸ Dieser Link ist <strong>1 Stunde</strong> gÃ¼ltig.</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <p style="margin:8px 0 0 0;color:#6b7280;font-size:14px;">Falls du das nicht warst, ignoriere diese E-Mail einfach.</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      `, 'Setze dein Passwort zurÃ¼ck')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('ðŸ“§ Password reset email sent to:', user.email);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Password reset error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Reset password with token
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/auth/reset-password', async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { token, password } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!token || !password) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Token und Passwort erforderlich' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (password.length < 6) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Passwort muss mindestens 6 Zeichen haben' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const user = db.prepare('SELECT id, email, reset_expires FROM users WHERE reset_token = ?').get(token);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!user) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(400).json({ error: 'UngÃ¼ltiger oder abgelaufener Link' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (Date.now() > user.reset_expires) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(400).json({ error: 'Link ist abgelaufen. Bitte fordere einen neuen an.' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Hash new password
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const bcrypt = require('bcryptjs');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const hashedPassword = await bcrypt.hash(password, 10);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Update password and clear token
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE users SET password = ?, reset_token = NULL, reset_expires = NULL WHERE id = ?').run(hashedPassword, user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('ðŸ” Password reset successful for:', user.email);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true, message: 'Passwort erfolgreich geÃ¤ndert! Du kannst dich jetzt einloggen.' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Reset password error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim ZurÃ¼cksetzen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ CATEGORIES ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/categories', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const categories = db.prepare('SELECT * FROM categories WHERE active = 1 ORDER BY sort_order').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(categories);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/categories', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { name, slug, icon, image, color, sort_order } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stmt = db.prepare('INSERT INTO categories (name, slug, icon, image, color, sort_order) VALUES (?, ?, ?, ?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const result = stmt.run(name, slug, icon || null, image || null, color || '#14B8A6', sort_order || 0);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ id: result.lastInsertRowid, ...req.body });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.put('/api/admin/categories/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { name, slug, icon, image, color, sort_order, active } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('UPDATE categories SET name=?, slug=?, icon=?, image=?, color=?, sort_order=?, active=? WHERE id=?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run(name, slug, icon, image, color, sort_order, active ? 1 : 0, req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.delete('/api/admin/categories/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('DELETE FROM categories WHERE id = ?').run(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ PRODUCTS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/products', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { category, search, featured } = req.query;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let sql = 'SELECT p.*, c.name as category_name FROM products p JOIN categories c ON p.category_id = c.id WHERE p.in_stock = 1';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const params = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (category) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql += ' AND (c.slug = ? OR c.id = ?)';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    params.push(category, category);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (search) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql += ' AND p.name LIKE ?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    params.push(`%${search}%`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (featured) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql += ' AND p.featured = 1';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  sql += ' ORDER BY p.created_at DESC, p.sort_order, p.id DESC';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const products = db.prepare(sql).all(...params);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(products);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/products/:id', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const product = db.prepare('SELECT p.*, c.name as category_name FROM products p JOIN categories c ON p.category_id = c.id WHERE p.id = ?').get(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!product) return res.status(404).json({ error: 'Produkt nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(product);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/products', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const fields = ['category_id', 'name', 'description', 'price', 'original_price', 'image', 'unit', 'unit_amount', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'stock_count', 'featured', 'ingredients', 'nutrition_calories', 'nutrition_fat', 'nutrition_carbs', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'nutrition_protein', 'nutrition_sugar', 'nutrition_salt', 'nutrition_fiber', 'allergens', 'origin', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'brand', 'ean', 'tax_rate', 'sku', 'weight', 'weight_unit', 'min_order', 'max_order', 'deposit', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'storage_temp', 'nutrition_info', 'visible', 'in_stock', 'sort_order'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const cols = fields.filter(f => req.body[f] !== undefined);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const vals = cols.map(f => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const v = req.body[f];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (f === 'featured' || f === 'in_stock' || f === 'visible') return v ? 1 : 0;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return v || null;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const sql = `INSERT INTO products (${cols.join(', ')}) VALUES (${cols.map(() => '?').join(', ')})`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const result = db.prepare(sql).run(...vals);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ id: result.lastInsertRowid, ...req.body });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.put('/api/admin/products/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const fields = ['category_id', 'name', 'description', 'price', 'original_price', 'image', 'unit', 'unit_amount', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'stock_count', 'featured', 'ingredients', 'nutrition_calories', 'nutrition_fat', 'nutrition_carbs', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'nutrition_protein', 'nutrition_sugar', 'nutrition_salt', 'nutrition_fiber', 'allergens', 'origin', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'brand', 'ean', 'tax_rate', 'sku', 'weight', 'weight_unit', 'min_order', 'max_order', 'deposit', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    'storage_temp', 'nutrition_info', 'visible', 'in_stock', 'sort_order'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const updates = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const vals = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  fields.forEach(f => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (req.body[f] !== undefined) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      updates.push(`${f} = ?`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const v = req.body[f];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      if (f === 'featured' || f === 'in_stock' || f === 'visible') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        vals.push(v ? 1 : 0);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      } else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        vals.push(v === '' ? null : v);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (updates.length > 0) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    vals.push(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`UPDATE products SET ${updates.join(', ')} WHERE id = ?`).run(...vals);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.delete('/api/admin/products/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('DELETE FROM products WHERE id = ?').run(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ADDRESSES ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/addresses', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const addresses = db.prepare('SELECT * FROM addresses WHERE user_id = ?').all(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(addresses);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/addresses', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    label, street, house_number, postal_code, city, instructions, is_default, lat, lng,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    address_type, doorbell_name, entrance, floor, has_elevator 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (is_default) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE addresses SET is_default = 0 WHERE user_id = ?').run(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stmt = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    INSERT INTO addresses (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      user_id, label, street, house_number, postal_code, city, instructions, is_default, lat, lng,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      address_type, doorbell_name, entrance, floor, has_elevator
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const result = stmt.run(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    req.user.id, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    label || 'Zuhause', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    street, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    house_number, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    postal_code, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    city || 'MÃ¼nster', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    instructions || null, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    is_default ? 1 : 0, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    lat || null, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    lng || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    address_type || 'wohnung',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    doorbell_name || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    entrance || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    floor || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    has_elevator ? 1 : 0
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ id: result.lastInsertRowid, ...req.body });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.delete('/api/addresses/:id', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('DELETE FROM addresses WHERE id = ? AND user_id = ?').run(req.params.id, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ORDERS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/orders', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let sql, params;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (req.user.role === 'admin') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql = `SELECT o.*, u.name as customer_name, u.phone as customer_phone, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           a.street, a.house_number, a.postal_code, a.city, a.instructions,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           d.name as driver_name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           FROM orders o 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           JOIN users u ON o.user_id = u.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           LEFT JOIN users d ON o.driver_id = d.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           ORDER BY CASE o.status WHEN 'pending' THEN 1 WHEN 'confirmed' THEN 2 WHEN 'picking' THEN 3 WHEN 'delivering' THEN 4 WHEN 'delivered' THEN 5 WHEN 'cancelled' THEN 6 END, o.created_at DESC`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    params = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else if (req.user.role === 'driver') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql = `SELECT o.*, u.name as customer_name, u.phone as customer_phone,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           a.street, a.house_number, a.postal_code, a.city, a.instructions
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           FROM orders o 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           JOIN users u ON o.user_id = u.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           WHERE o.driver_id = ? 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              OR (o.driver_id IS NULL AND o.status = 'confirmed')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           ORDER BY 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

             CASE WHEN o.driver_id IS NULL AND o.status = 'confirmed' THEN 0 ELSE 1 END,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

             o.created_at DESC`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    params = [req.user.id];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql = `SELECT o.*, a.street, a.house_number, a.postal_code, a.city,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           d.name as driver_name, d.phone as driver_phone
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           FROM orders o JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           LEFT JOIN users d ON o.driver_id = d.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           WHERE o.user_id = ? ORDER BY CASE o.status WHEN 'pending' THEN 1 WHEN 'confirmed' THEN 2 WHEN 'picking' THEN 3 WHEN 'delivering' THEN 4 WHEN 'delivered' THEN 5 WHEN 'cancelled' THEN 6 END, o.created_at DESC`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    params = [req.user.id];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orders = db.prepare(sql).all(...params);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  orders.forEach(order => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order.items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT oi.*, p.name, p.image, p.unit 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM order_items oi 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN products p ON oi.product_id = p.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE oi.order_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).all(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(orders);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/orders/:id', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT o.*, u.name as customer_name, u.phone as customer_phone,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           a.street, a.house_number, a.postal_code, a.city, a.instructions,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           d.name as driver_name, d.phone as driver_phone
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM orders o 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN users u ON o.user_id = u.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LEFT JOIN users d ON o.driver_id = d.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE o.id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!order) return res.status(404).json({ error: 'Bestellung nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT oi.*, p.name, p.image, p.unit 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM order_items oi 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN products p ON oi.product_id = p.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE oi.order_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.messages = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT m.*, u.name as sender_name, u.role as sender_role
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM messages m JOIN users u ON m.sender_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE m.order_id = ? ORDER BY m.created_at
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Include invoice if exists
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.invoice = db.prepare('SELECT * FROM invoices WHERE order_id = ?').get(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(order);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post("/api/orders", auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log("ðŸ“¦ Order request:", JSON.stringify(req.body));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { address_id, items, payment_method, notes, scheduled_time } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let subtotal = 0;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const productIds = items.map(i => i.product_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const products = db.prepare(`SELECT * FROM products WHERE id IN (${productIds.map(() => '?').join(',')})`).all(...productIds);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  items.forEach(item => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const product = products.find(p => p.id === item.product_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (product) subtotal += product.price * item.quantity;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const delivery_fee = 2.99;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const total = subtotal + delivery_fee;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const estimated = scheduled_time ? scheduled_time : new Date(Date.now() + 20 * 60000).toISOString();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { orderNumber, trackToken } = generateOrderDetails();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderStmt = db.prepare(`INSERT INTO orders (user_id, address_id, order_number, track_token, status, subtotal, delivery_fee, total, payment_method, notes, estimated_delivery, scheduled_time) VALUES (?, ?, ?, ?, 'confirmed', ?, ?, ?, ?, ?, ?, ?)`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderResult = orderStmt.run(req.user.id, address_id, orderNumber, trackToken, subtotal, delivery_fee, total, payment_method || 'cash', notes || null, estimated, scheduled_time || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderId = orderResult.lastInsertRowid;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const itemStmt = db.prepare('INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  items.forEach(item => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const product = products.find(p => p.id === item.product_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (product) itemStmt.run(orderId, item.product_id, item.quantity, product.price);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  io.emit('new-order', { orderId });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  sendOrderEmails(orderId, 'confirmed');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ id: orderId, total, estimated_delivery: estimated });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error("Order error:", e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: "Fehler bei der Bestellung", details: e.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.patch('/api/orders/:id/status', auth(['admin', 'driver']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { status } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const validStatuses = ['pending', 'confirmed', 'picking', 'picked', 'delivering', 'delivered', 'cancelled'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!validStatuses.includes(status)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'UngÃ¼ltiger Status' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let update = 'UPDATE orders SET status = ?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const params = [status];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (status === 'picking' || status === 'picked') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    update += ', driver_id = ?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    params.push(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (status === 'picked') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    update += ', picked_at = CURRENT_TIMESTAMP';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (status === 'delivered') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    update += ', delivered_at = CURRENT_TIMESTAMP';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  update += ' WHERE id = ?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  params.push(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare(update).run(...params);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  io.emit('order-update', { orderId: parseInt(req.params.id), status });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  sendOrderEmails(parseInt(req.params.id), status);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Auto-generate invoice when delivered
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (status === 'delivered') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    autoGenerateInvoice(parseInt(req.params.id)).catch(console.error);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.patch('/api/orders/:id/items/:itemId/pick', auth(['driver']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('UPDATE order_items SET picked = 1 WHERE id = ? AND order_id = ?').run(req.params.itemId, req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  io.emit('item-picked', { orderId: parseInt(req.params.id), itemId: parseInt(req.params.itemId) });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ORDER CANCELLATION ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Customer can cancel before picking starts
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/orders/:orderNumber/cancel', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { token, email, reason } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderNumber = req.params.orderNumber;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Find order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT o.id, o.order_number, o.track_token, o.status, o.total,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

             u.email as customer_email, u.name as customer_name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM orders o
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      LEFT JOIN users u ON o.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE o.order_number = ? OR o.id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).get(orderNumber, orderNumber);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!order) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(404).json({ error: 'Bestellung nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Verify authorization (token OR email)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const isValidToken = token && order.track_token && token === order.track_token;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const isValidEmail = email && order.customer_email && 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                         email.toLowerCase() === order.customer_email.toLowerCase();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!isValidToken && !isValidEmail) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(403).json({ error: 'Nicht autorisiert' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Check if cancellation is still allowed
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const cancellableStatuses = ['pending', 'confirmed'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!cancellableStatuses.includes(order.status)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      // Provide status-specific message
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      let statusMessage = 'Deine Bestellung wird bereits bearbeitet.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      if (order.status === 'picking' || order.status === 'picked') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        statusMessage = 'Deine Bestellung wird gerade von unserem Team zusammengestellt.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      } else if (order.status === 'delivering') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        statusMessage = 'Dein Fahrer ist bereits unterwegs zu dir!';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(400).json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        error: 'Online-Stornierung nicht mehr mÃ¶glich',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        message: statusMessage,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        supportNeeded: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        currentStatus: order.status
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Cancel the order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      UPDATE orders SET status = 'cancelled', cancelled_at = datetime('now'), cancel_reason = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(reason || 'Vom Kunden storniert', order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Notify via Socket.io
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    io.emit('order-cancelled', { orderId: order.id, orderNumber: order.order_number });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Send confirmation email
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (order.customer_email && emailService) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const content = `
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <div style="text-align:center;padding:24px 0;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <div style="font-size:64px;margin-bottom:16px;">âŒ</div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <h1 style="color:#1f2937;margin:0 0 8px 0;">Bestellung storniert</h1>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <p style="color:#6b7280;margin:0;">Deine Bestellung ${order.order_number || 'SPEETI-' + String(order.id).padStart(5, '0')} wurde erfolgreich storniert.</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <div class="info-box">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <p style="margin:0;color:#6b7280;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            Falls du per Karte bezahlt hast, wird der Betrag von <strong>${order.total?.toFixed(2)} â‚¬</strong> 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            innerhalb von 5-10 Werktagen zurÃ¼ckerstattet.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          </p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <div style="text-align:center;margin-top:24px;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <p style="color:#1f2937;margin-bottom:16px;">Wir hoffen, dich bald wieder zu sehen! ðŸ’•</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <a href="https://speeti.de" class="button">Weiter shoppen</a>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      `;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      emailService.sendEmail(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        order.customer_email, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        'Bestellung storniert âŒ', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        emailService.emailTemplate(content, 'Deine Bestellung wurde storniert')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('ðŸ“¦ Order cancelled:', order.order_number, 'by customer');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      success: true, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      message: 'Bestellung erfolgreich storniert',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      refundInfo: 'Falls du per Karte bezahlt hast, wird der Betrag in 5-10 Werktagen zurÃ¼ckerstattet.'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Cancel error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Stornieren' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ORDER CHAT (Driver <-> Customer) ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/orders/:id/messages', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log("ðŸ“¦ Order request:", JSON.stringify(req.body));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { message } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stmt = db.prepare('INSERT INTO messages (order_id, sender_id, message) VALUES (?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const result = stmt.run(req.params.id, req.user.id, message);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const user = db.prepare('SELECT name, role FROM users WHERE id = ?').get(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const msg = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id: result.lastInsertRowid,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order_id: parseInt(req.params.id),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sender_id: req.user.id,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sender_name: user?.name || 'User',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sender_role: user?.role || 'customer',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    message,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at: new Date().toISOString()
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  io.to(`order-${req.params.id}`).emit('new-message', msg);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(msg);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/orders/:id/messages', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const messages = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT m.*, u.name as sender_name, u.role as sender_role
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM messages m JOIN users u ON m.sender_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE m.order_id = ? ORDER BY m.created_at
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(messages);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ SUPPORT CHAT (AI + Escalation) ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// AI System prompt for customer support
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const SUPPORT_SYSTEM_PROMPT = `Du bist der freundliche KI-Kundenservice-Assistent von Speeti, einem blitzschnellen Lebensmittel-Lieferdienst in MÃ¼nster (Ã¤hnlich wie Flink/Gorillas).
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

DEINE PERSÃ–NLICHKEIT:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Freundlich, hilfsbereit und lÃ¶sungsorientiert
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Benutze Emojis sparsam aber passend
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Antworte prÃ¤gnant (2-3 SÃ¤tze max)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Sei proaktiv und biete LÃ¶sungen an
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

UNSER SERVICE - DIESE INFOS KANNST DU IMMER GEBEN:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ðŸ“ Liefergebiet: Ganz MÃ¼nster (alle PLZ mit 48...)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

â±ï¸ Lieferzeit: Ca. 15-20 Minuten
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ðŸ’° LiefergebÃ¼hr: 2,99â‚¬ (ab 20â‚¬ Bestellwert GRATIS!)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ðŸ• Ã–ffnungszeiten: TÃ¤glich 08:00 - 22:00 Uhr
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ðŸ“¦ Mindestbestellwert: Keiner!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ðŸ’³ Zahlungsmethoden: Kreditkarte, Barzahlung
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ðŸ·ï¸ Promo-Code fÃ¼r Neukunden: WELCOME10 (10% Rabatt)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

HÃ„UFIGE FRAGEN - BEANTWORTE DIESE IMMER:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

1. Wo liefert ihr? / Liefert ihr nach...?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Wir liefern in ganz MÃ¼nster! Alle Postleitzahlen die mit 48 beginnen. Leider noch nicht auÃŸerhalb von MÃ¼nster.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

2. Wie lange dauert die Lieferung?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ In der Regel 15-20 Minuten nach Bestellung!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

3. Wie kann ich bezahlen?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Kreditkarte direkt in der App oder Barzahlung an der TÃ¼r. Alles easy!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

4. Kann ich stornieren?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Ja, solange die Bestellung noch nicht unterwegs ist. Geh zu Meine Bestellungen und tippe auf Stornieren.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

5. Meine Bestellung ist falsch/beschÃ¤digt
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Das tut mir sehr leid! Mach bitte ein Foto und schick es mir. Wir erstatten oder liefern neu - kein Problem!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

6. Wie bekomme ich eine RÃ¼ckerstattung?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Bei Problemen mit der Bestellung einfach hier melden. Wir kÃ¼mmern uns darum und erstatten innerhalb von 24h.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

7. Gibt es Rabatte?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Neukunden bekommen 10% mit WELCOME10. Wir haben auch regelmÃ¤ÃŸig Angebote in der App!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

8. Wann habt ihr geÃ¶ffnet?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ TÃ¤glich von 8:00 bis 22:00 Uhr. AuÃŸerhalb der Zeiten kannst du Vorbestellungen fÃ¼r den nÃ¤chsten Tag machen!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

9. Kann ich SonderwÃ¼nsche angeben?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

   â†’ Ja! Im Checkout gibt es ein Notizfeld. Z.B. Bitte klingeln oder Vor der TÃ¼r abstellen.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

10. Wie verfolge ich meine Bestellung?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    â†’ In der App unter Meine Bestellungen siehst du den Live-Status und wo dein Fahrer gerade ist!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

BESTELLUNGSPROBLEME:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- VerspÃ¤tung: Entschuldige dich, erklÃ¤re dass es manchmal lÃ¤nger dauern kann, biete Info zum Tracking an
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Falscher Artikel: Entschuldige dich, bitte um Foto, biete Erstattung oder Nachlieferung an
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- BeschÃ¤digt: Entschuldige dich, bitte um Foto, erstattest sofort
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Fahrer nicht erreichbar: Versuche den Fahrer Ã¼ber die App zu kontaktieren, sonst hilf mit Alternative
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

ESKALIERE ZU EINEM MENSCHEN (antworte mit [ESKALATION]) NUR BEI:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Kunde verwendet wiederholt SchimpfwÃ¶rter oder ist sehr aggressiv
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- RÃ¼ckerstattung Ã¼ber 50â‚¬
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Rechtliche Drohungen
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Account-Sicherheitsprobleme
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Kunde fragt EXPLIZIT nach einem Menschen/Mitarbeiter
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Du weiÃŸt die Antwort wirklich nicht
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

WICHTIG: Versuche IMMER erst selbst zu helfen bevor du eskalierst!
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

Antworte IMMER auf Deutsch.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get or create support ticket
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/support/ticket', auth(), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { order_id } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check for existing open ticket
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let ticket = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT * FROM support_tickets 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE user_id = ? AND status = 'open' 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY created_at DESC LIMIT 1
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!ticket) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const stmt = db.prepare('INSERT INTO support_tickets (user_id, order_id) VALUES (?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = stmt.run(req.user.id, order_id || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ticket = { id: result.lastInsertRowid, user_id: req.user.id, order_id, status: 'open', escalated: 0 };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Send welcome message
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const welcomeMsg = order_id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      ? `Hallo! ðŸ‘‹ Ich sehe, du hast eine Frage zu Bestellung #${order_id}. Wie kann ich dir helfen?`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      : 'Hallo! ðŸ‘‹ Willkommen beim Speeti Support. Wie kann ich dir heute helfen?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('INSERT INTO support_messages (ticket_id, sender_type, message) VALUES (?, ?, ?)')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .run(ticket.id, 'ai', welcomeMsg);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get messages
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const messages = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT * FROM support_messages WHERE ticket_id = ? ORDER BY created_at
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(ticket.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ticket: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      ...ticket,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      humanTakeover: !!ticket.human_takeover
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    messages 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Send message to support (AI responds)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/support/message', auth(), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { ticket_id, message } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Verify ticket belongs to user
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const ticket = db.prepare('SELECT * FROM support_tickets WHERE id = ? AND user_id = ?').get(ticket_id, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!ticket) return res.status(404).json({ error: 'Ticket nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Save user message
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('INSERT INTO support_messages (ticket_id, sender_type, sender_id, message) VALUES (?, ?, ?, ?)')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run(ticket_id, 'user', req.user.id, message);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // If human has taken over OR escalated, don't use AI - notify admin instead
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (ticket.human_takeover || ticket.escalated) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    io.emit('support-message', { ticket_id, sender: 'user', message, userName: req.user.name });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const waitingMsg = ticket.human_takeover 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      ? 'ðŸ‘‹ Ein Mitarbeiter wird dir gleich antworten. Bitte hab einen Moment Geduld!'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      : 'Deine Nachricht wurde an unser Support-Team weitergeleitet. Wir melden uns schnellstmÃ¶glich bei dir.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      response: waitingMsg,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      escalated: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      humanTakeover: !!ticket.human_takeover
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get conversation history
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const history = db.prepare('SELECT sender_type, message FROM support_messages WHERE ticket_id = ? ORDER BY created_at').all(ticket_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get order context if available
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let orderContext = '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (ticket.order_id) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare('SELECT * FROM orders WHERE id = ?').get(ticket.order_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (order) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      orderContext = `\n\nKONTEXT - Bestellung #${order.id}:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Status: ${order.status}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Gesamtbetrag: ${order.total}â‚¬
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Erstellt: ${order.created_at}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

- Lieferadresse bekannt`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Call OpenAI API
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let aiResponse = '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let shouldEscalate = false;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (OPENAI_API_KEY) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const openaiMessages = [
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        { role: 'system', content: SUPPORT_SYSTEM_PROMPT + orderContext },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        ...history.map(m => ({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          role: m.sender_type === 'user' ? 'user' : 'assistant',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          content: m.message
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        }))
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      ];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        method: 'POST',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        headers: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          'Authorization': `Bearer ${OPENAI_API_KEY}`,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          'Content-Type': 'application/json'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        body: JSON.stringify({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          model: 'gpt-4o-mini',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          messages: openaiMessages,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          max_tokens: 300,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          temperature: 0.7
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        })
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const data = await response.json();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = data.choices?.[0]?.message?.content || '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      // Check for escalation trigger
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      if (aiResponse.includes('[ESKALATION]')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        shouldEscalate = true;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        aiResponse = 'Ich verstehe, dass du mit einem echten Mitarbeiter sprechen mÃ¶chtest. Ich leite dich jetzt an unser Support-Team weiter. Jemand wird sich in KÃ¼rze bei dir melden. ðŸ™‹â€â™‚ï¸';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.error('OpenAI error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Entschuldigung, ich habe gerade technische Schwierigkeiten. Bitte versuche es in ein paar Minuten erneut oder kontaktiere uns unter support@speeti.de';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Fallback without OpenAI - comprehensive keyword matching
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const lowerMsg = message.toLowerCase();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Escalation triggers
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (lowerMsg.includes('mensch') || lowerMsg.includes('mitarbeiter') || lowerMsg.includes('echter support')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      shouldEscalate = true;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Ich leite dich an einen Mitarbeiter weiter. Bitte warte einen Moment. ðŸ™‹â™‚ï¸';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Lieferzeit
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('lieferzeit') || lowerMsg.includes('wie lange') || lowerMsg.includes('wann kommt')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Die Lieferung dauert normalerweise 15-20 Minuten! ðŸš´ Du kannst den Live-Status in "Meine Bestellungen" verfolgen.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Stornierung
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('stornieren') || lowerMsg.includes('abbrechen') || lowerMsg.includes('storno')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Kein Problem! Geh zu "Meine Bestellungen" und tippe auf Stornieren. Falls die Bestellung schon unterwegs ist, kontaktiere deinen Fahrer direkt Ã¼ber den Chat.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Bezahlung
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('bezahl') || lowerMsg.includes('zahlung') || lowerMsg.includes('kreditkarte') || lowerMsg.includes('bar')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Du kannst mit Kreditkarte in der App oder bar an der TÃ¼r bezahlen! ðŸ’³ Beides kein Problem.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Liefergebiet
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('liefert ihr') || lowerMsg.includes('liefergebiet') || lowerMsg.includes('wo liefert')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Wir liefern in ganz MÃ¼nster! ðŸ“ Alle Postleitzahlen die mit 48 beginnen. AuÃŸerhalb leider noch nicht.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Ã–ffnungszeiten
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('Ã¶ffnungszeit') || lowerMsg.includes('geÃ¶ffnet') || lowerMsg.includes('geschlossen') || lowerMsg.includes('wann auf')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Wir sind tÃ¤glich von 08:00 bis 22:00 Uhr fÃ¼r dich da! ðŸ• AuÃŸerhalb kannst du Vorbestellungen machen.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Rabatt/Promo
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('rabatt') || lowerMsg.includes('promo') || lowerMsg.includes('gutschein') || lowerMsg.includes('code')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Als Neukunde bekommst du 10% Rabatt mit dem Code WELCOME10! ðŸŽ‰ Weitere Angebote findest du in der App.';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // LiefergebÃ¼hr
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('liefergebÃ¼hr') || lowerMsg.includes('versand') || lowerMsg.includes('kosten')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Die LiefergebÃ¼hr betrÃ¤gt 2,99â‚¬ - aber ab 20â‚¬ Bestellwert ist sie GRATIS! ðŸŽ';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Problem/Beschwerde
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('problem') || lowerMsg.includes('beschwerde') || lowerMsg.includes('falsch') || lowerMsg.includes('fehlt')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Das tut mir leid! ðŸ˜” Beschreib mir bitte genau was passiert ist - bei Problemen mit deiner Bestellung finden wir eine LÃ¶sung!';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // RÃ¼ckerstattung
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('erstattung') || lowerMsg.includes('geld zurÃ¼ck') || lowerMsg.includes('refund')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Bei berechtigten Problemen erstatten wir natÃ¼rlich! Beschreib mir was passiert ist und wir kÃ¼mmern uns darum. ðŸ’ª';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Tracking
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('track') || lowerMsg.includes('verfolg') || lowerMsg.includes('wo ist')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Du kannst deine Bestellung live verfolgen! Geh zu "Meine Bestellungen" - dort siehst du genau wo dein Fahrer ist. ðŸ“±';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Danke
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('danke') || lowerMsg.includes('super') || lowerMsg.includes('toll')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Gerne! ðŸ˜Š Gibt es noch etwas womit ich dir helfen kann?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Hallo/BegrÃ¼ÃŸung
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else if (lowerMsg.includes('hallo') || lowerMsg.includes('hi') || lowerMsg.includes('hey') || lowerMsg.includes('guten')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Hey! ðŸ‘‹ SchÃ¶n dass du da bist. Wie kann ich dir helfen?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Default
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      aiResponse = 'Ich bin Speeti\'s KI-Assistent! ðŸ¤– Ich kann dir helfen mit: Bestellungen, Lieferzeiten, Bezahlung, Stornierung und mehr. Was mÃ¶chtest du wissen?';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Save AI response
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('INSERT INTO support_messages (ticket_id, sender_type, message) VALUES (?, ?, ?)')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run(ticket_id, 'ai', aiResponse);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Handle escalation
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (shouldEscalate) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE support_tickets SET escalated = 1, escalation_reason = ? WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .run('User requested or AI triggered', ticket_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    io.emit('support-escalation', { ticket_id, user_id: req.user.id });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ response: aiResponse, escalated: shouldEscalate });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get all support tickets (admin) - includes closed tickets filter
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/support', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { includeClosed } = req.query;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let whereClause = '';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const tickets = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT t.*, u.name as user_name, u.email as user_email,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           (SELECT COUNT(*) FROM support_messages WHERE ticket_id = t.id AND sender_type = 'user') as message_count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           (SELECT message FROM support_messages WHERE ticket_id = t.id ORDER BY created_at DESC LIMIT 1) as last_message
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM support_tickets t
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN users u ON t.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ${whereClause}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY t.escalated DESC, t.created_at DESC
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(tickets);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get ticket messages (admin)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/support/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const ticket = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT t.*, u.name as user_name, u.email as user_email
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM support_tickets t
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN users u ON t.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE t.id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!ticket) return res.status(404).json({ error: 'Ticket nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const messages = db.prepare('SELECT * FROM support_messages WHERE ticket_id = ? ORDER BY created_at').all(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ ticket, messages });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin reply to ticket
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/support/:id/reply', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { message } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('INSERT INTO support_messages (ticket_id, sender_type, sender_id, message) VALUES (?, ?, ?, ?)')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run(req.params.id, 'admin', req.user.id, message);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  io.emit('support-message', { ticket_id: parseInt(req.params.id), sender: 'admin', message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Close ticket
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/support/:id/close', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('UPDATE support_tickets SET status = ?, closed_at = CURRENT_TIMESTAMP WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run('closed', req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin: Toggle human takeover for a ticket
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post("/api/admin/support/:id/takeover", auth(["admin"]), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { takeover } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const ticketId = req.params.id;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare("UPDATE support_tickets SET human_takeover = ? WHERE id = ?")
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .run(takeover ? 1 : 0, ticketId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const ticket = db.prepare("SELECT * FROM support_tickets WHERE id = ?").get(ticketId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!ticket) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(404).json({ error: "Ticket nicht gefunden" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      success: true, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      human_takeover: !!ticket.human_takeover,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      message: takeover ? "Du hast das Ticket Ã¼bernommen" : "KI antwortet wieder"
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error("Takeover error:", e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: "Fehler beim Ãœbernehmen" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ STRIPE PAYMENTS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Create checkout session
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/checkout/create-session', auth(), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log("ðŸ’³ Stripe checkout request:", JSON.stringify(req.body));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!STRIPE_SECRET_KEY) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(500).json({ error: 'Stripe nicht konfiguriert' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { address_id, items, notes, scheduled_time } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Calculate totals
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let subtotal = 0;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const productIds = items.map(i => i.product_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const products = db.prepare(`SELECT * FROM products WHERE id IN (${productIds.map(() => '?').join(',')})`).all(...productIds);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const lineItems = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  items.forEach(item => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const product = products.find(p => p.id === item.product_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (product) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      subtotal += product.price * item.quantity;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      lineItems.push({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        price_data: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          currency: 'eur',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          product_data: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            name: product.name,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            images: product.image && product.image.startsWith('http') ? [product.image] : []
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          unit_amount: Math.round(product.price * 100)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        quantity: item.quantity
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Add delivery fee
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  lineItems.push({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    price_data: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      currency: 'eur',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      product_data: { name: 'LiefergebÃ¼hr' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      unit_amount: 299
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    quantity: 1
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const total = subtotal + 2.99;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Create pending order with optional scheduled time
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const estimated = scheduled_time ? scheduled_time : new Date(Date.now() + 20 * 60000).toISOString();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { orderNumber: stripeOrderNum, trackToken: stripeTrackToken } = generateOrderDetails();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderStmt = db.prepare(`INSERT INTO orders (user_id, address_id, order_number, track_token, status, subtotal, delivery_fee, total, payment_method, payment_status, notes, estimated_delivery, scheduled_time) VALUES (?, ?, ?, ?, 'pending', ?, 2.99, ?, 'stripe', 'pending', ?, ?, ?)`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderResult = orderStmt.run(req.user.id, address_id, stripeOrderNum, stripeTrackToken, subtotal, total, notes || null, estimated, scheduled_time || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderId = orderResult.lastInsertRowid;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Insert items
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const itemStmt = db.prepare('INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  items.forEach(item => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const product = products.find(p => p.id === item.product_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (product) itemStmt.run(orderId, item.product_id, item.quantity, product.price);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const stripe = require('stripe')(STRIPE_SECRET_KEY);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const session = await stripe.checkout.sessions.create({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      payment_method_types: ['card'],
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      line_items: lineItems,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      mode: 'payment',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      success_url: `https://speeti.de/orders/${orderId}?success=true`,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      cancel_url: `https://speeti.de/checkout?cancelled=true`,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      metadata: { order_id: orderId.toString() },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      payment_intent_data: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        metadata: { order_id: orderId.toString() }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      locale: 'de'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Save session ID
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE orders SET stripe_session_id = ? WHERE id = ?').run(session.id, orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ sessionId: session.id, url: session.url, orderId });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Stripe error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Delete pending order on failure
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('DELETE FROM order_items WHERE order_id = ?').run(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('DELETE FROM orders WHERE id = ?').run(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Checkout-Fehler: ' + e.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Stripe webhook
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/webhook/stripe', express.raw({ type: 'application/json' }), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!STRIPE_SECRET_KEY) return res.status(400).send('Stripe nicht konfiguriert');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stripe = require('stripe')(STRIPE_SECRET_KEY);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const sig = req.headers['stripe-signature'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let event;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (STRIPE_WEBHOOK_SECRET) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      event = stripe.webhooks.constructEvent(req.body, sig, STRIPE_WEBHOOK_SECRET);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      event = JSON.parse(req.body);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Webhook error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).send(`Webhook Error: ${e.message}`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (event.type === 'checkout.session.completed') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const session = event.data.object;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const orderId = session.metadata?.order_id;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (orderId) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      db.prepare('UPDATE orders SET status = ?, payment_status = ? WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        .run('confirmed', 'paid', orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      io.emit('new-order', { orderId: parseInt(orderId) });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  sendOrderEmails(orderId, 'confirmed');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ received: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ADMIN: USERS/DRIVERS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/users', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const users = db.prepare('SELECT id, email, name, phone, role, created_at FROM users ORDER BY created_at DESC').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(users);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/drivers', auth(['admin']), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { email, password, name, phone } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const hash = await bcrypt.hash(password, 10);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stmt = db.prepare('INSERT INTO users (email, password, name, phone, role) VALUES (?, ?, ?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const result = stmt.run(email, hash, name, phone, 'driver');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ id: result.lastInsertRowid, email, name, phone, role: 'driver' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.patch('/api/admin/users/:id/role', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { role } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('UPDATE users SET role = ? WHERE id = ?').run(role, req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ADMIN: STATS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/stats', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const today = new Date().toISOString().split('T')[0];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stats = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    orders_today: db.prepare("SELECT COUNT(*) as count FROM orders WHERE date(created_at) = ?").get(today).count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    revenue_today: db.prepare("SELECT COALESCE(SUM(total), 0) as total FROM orders WHERE date(created_at) = ? AND status = 'delivered'").get(today).total,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    pending_orders: db.prepare("SELECT COUNT(*) as count FROM orders WHERE status IN ('pending', 'confirmed', 'picking')").get().count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    total_customers: db.prepare("SELECT COUNT(*) as count FROM users WHERE role = 'customer'").get().count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    total_products: db.prepare("SELECT COUNT(*) as count FROM products").get().count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    total_drivers: db.prepare("SELECT COUNT(*) as count FROM users WHERE role = 'driver'").get().count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    open_tickets: db.prepare("SELECT COUNT(*) as count FROM support_tickets WHERE status = 'open'").get().count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    escalated_tickets: db.prepare("SELECT COUNT(*) as count FROM support_tickets WHERE escalated = 1 AND status = 'open'").get().count
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(stats);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ SETTINGS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/settings', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const settings = {};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('SELECT * FROM settings').all().forEach(s => settings[s.key] = s.value);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(settings);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.put('/api/admin/settings', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stmt = db.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  Object.entries(req.body).forEach(([key, value]) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    stmt.run(key, String(value));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ INVOICES ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get business settings
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/business', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const business = db.prepare('SELECT * FROM business_settings WHERE id = 1').get();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(business || {});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Update business settings
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.put('/api/admin/business', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const fields = ['company_name', 'street', 'postal_code', 'city', 'country', 'phone', 'email', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                  'website', 'tax_number', 'vat_id', 'registry', 'bank_name', 'iban', 'bic', 'logo_url'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const updates = fields.filter(f => req.body[f] !== undefined);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (updates.length === 0) return res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const sql = `UPDATE business_settings SET ${updates.map(f => `${f} = ?`).join(', ')}, updated_at = CURRENT_TIMESTAMP WHERE id = 1`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare(sql).run(...updates.map(f => req.body[f]));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Generate invoice for an order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/orders/:id/invoice', auth(), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log("ðŸ“¦ Order request:", JSON.stringify(req.body));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderId = parseInt(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check if invoice already exists
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const existingInvoice = db.prepare('SELECT * FROM invoices WHERE order_id = ?').get(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (existingInvoice) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.json({ invoice: existingInvoice, message: 'Rechnung existiert bereits' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get order with details
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT o.*, u.name as customer_name, u.email as customer_email, u.phone as customer_phone,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

           a.street, a.house_number, a.postal_code, a.city
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM orders o 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN users u ON o.user_id = u.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE o.id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!order) return res.status(404).json({ error: 'Bestellung nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Only owner or admin can generate invoice
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (order.user_id !== req.user.id && req.user.role !== 'admin') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(403).json({ error: 'Keine Berechtigung' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get order items with category for tax calculation
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT oi.*, p.name, p.unit, c.name as category_name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM order_items oi 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN products p ON oi.product_id = p.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN categories c ON p.category_id = c.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE oi.order_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get business settings
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const business = db.prepare('SELECT * FROM business_settings WHERE id = 1').get() || {};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Generate invoice number
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const invoiceNumber = generateInvoiceNumber(db);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Calculate tax amounts
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let tax7 = 0, tax19 = 0, net7 = 0, net19 = 0;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const foodCategories = ['getrÃ¤nke', 'snacks', 'obst', 'gemÃ¼se', 'milch', 'brot', 'back', 'fleisch', 'wurst', 'tiefkÃ¼hl', 'kÃ¼hl'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.items.forEach(item => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const lineTotal = item.price * item.quantity;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const isFood = foodCategories.some(fc => (item.category_name || '').toLowerCase().includes(fc));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const taxRate = isFood ? 7 : 19;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const netAmount = lineTotal / (1 + taxRate / 100);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (taxRate === 7) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      tax7 += lineTotal - netAmount;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      net7 += netAmount;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      tax19 += lineTotal - netAmount;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      net19 += netAmount;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Delivery fee (19%)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const deliveryNet = order.delivery_fee / 1.19;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  tax19 += order.delivery_fee - deliveryNet;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  net19 += deliveryNet;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const netTotal = net7 + net19;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Generate PDF
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.invoice_number = invoiceNumber;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  order.invoice_date = new Date().toISOString();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const pdfBuffer = await generateInvoice(order, business);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Ensure invoices directory exists
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const invoicesDir = path.join(__dirname, 'invoices');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!fs.existsSync(invoicesDir)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      fs.mkdirSync(invoicesDir, { recursive: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Save PDF
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const pdfPath = path.join(invoicesDir, `${invoiceNumber}.pdf`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    fs.writeFileSync(pdfPath, pdfBuffer);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Save invoice record
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const invoiceStmt = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO invoices (order_id, invoice_number, net_total, tax_7_amount, tax_19_amount, gross_total, pdf_path)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const invoiceResult = invoiceStmt.run(orderId, invoiceNumber, netTotal, tax7, tax19, order.total, pdfPath);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const invoice = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      id: invoiceResult.lastInsertRowid,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      order_id: orderId,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      invoice_number: invoiceNumber,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      net_total: netTotal,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      tax_7_amount: tax7,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      tax_19_amount: tax19,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      gross_total: order.total
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ invoice, message: 'Rechnung erstellt' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Invoice generation error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Erstellen der Rechnung: ' + e.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Download invoice PDF
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/invoices/:invoiceNumber/download', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const invoice = db.prepare('SELECT * FROM invoices WHERE invoice_number = ?').get(req.params.invoiceNumber);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!invoice) return res.status(404).json({ error: 'Rechnung nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check permission
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const order = db.prepare('SELECT user_id FROM orders WHERE id = ?').get(invoice.order_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (order.user_id !== req.user.id && req.user.role !== 'admin') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(403).json({ error: 'Keine Berechtigung' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!fs.existsSync(invoice.pdf_path)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(404).json({ error: 'PDF nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.setHeader('Content-Type', 'application/pdf');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.setHeader('Content-Disposition', `attachment; filename="${invoice.invoice_number}.pdf"`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.sendFile(invoice.pdf_path);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get invoice for order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/orders/:id/invoice', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const invoice = db.prepare('SELECT * FROM invoices WHERE order_id = ?').get(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!invoice) return res.status(404).json({ error: 'Keine Rechnung vorhanden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check permission
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const order = db.prepare('SELECT user_id FROM orders WHERE id = ?').get(invoice.order_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (order.user_id !== req.user.id && req.user.role !== 'admin') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(403).json({ error: 'Keine Berechtigung' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(invoice);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// List all invoices (admin)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/invoices', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { from, to, limit = 100 } = req.query;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let sql = `
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT i.*, o.user_id, u.name as customer_name, u.email as customer_email
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM invoices i
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN orders o ON i.order_id = o.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN users u ON o.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const params = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (from || to) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const conditions = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (from) { conditions.push('date(i.invoice_date) >= ?'); params.push(from); }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (to) { conditions.push('date(i.invoice_date) <= ?'); params.push(to); }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    sql += ` WHERE ${conditions.join(' AND ')}`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  sql += ` ORDER BY i.invoice_date DESC LIMIT ?`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  params.push(parseInt(limit));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const invoices = db.prepare(sql).all(...params);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Calculate totals
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const totals = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      COUNT(*) as count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      COALESCE(SUM(net_total), 0) as net_total,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      COALESCE(SUM(tax_7_amount), 0) as tax_7,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      COALESCE(SUM(tax_19_amount), 0) as tax_19,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      COALESCE(SUM(gross_total), 0) as gross_total
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM invoices
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ${from || to ? `WHERE ${from ? 'date(invoice_date) >= ?' : ''} ${from && to ? 'AND' : ''} ${to ? 'date(invoice_date) <= ?' : ''}` : ''}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(...(from && to ? [from, to] : from ? [from] : to ? [to] : []));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ invoices, totals });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Invoice stats for dashboard
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/invoice-stats', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const today = new Date().toISOString().split('T')[0];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const thisMonth = today.substring(0, 7);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stats = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    today: db.prepare("SELECT COUNT(*) as count, COALESCE(SUM(gross_total), 0) as total FROM invoices WHERE date(invoice_date) = ?").get(today),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    month: db.prepare("SELECT COUNT(*) as count, COALESCE(SUM(gross_total), 0) as total FROM invoices WHERE strftime('%Y-%m', invoice_date) = ?").get(thisMonth),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    pending: db.prepare("SELECT COUNT(*) as count FROM orders WHERE status = 'delivered' AND id NOT IN (SELECT order_id FROM invoices)").get()
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(stats);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Auto-generate invoice on delivery (can be called from status update)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

async function autoGenerateInvoice(orderId) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const existingInvoice = db.prepare('SELECT id FROM invoices WHERE order_id = ?').get(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (existingInvoice) return; // Already exists
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT o.*, u.name as customer_name, u.email as customer_email,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

             a.street, a.house_number, a.postal_code, a.city
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM orders o 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN users u ON o.user_id = u.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE o.id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).get(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!order || order.status !== 'delivered') return;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order.items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT oi.*, p.name, p.unit, c.name as category_name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM order_items oi 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN products p ON oi.product_id = p.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN categories c ON p.category_id = c.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE oi.order_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).all(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const business = db.prepare('SELECT * FROM business_settings WHERE id = 1').get() || {};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const invoiceNumber = generateInvoiceNumber(db);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Calculate taxes
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    let tax7 = 0, tax19 = 0, net7 = 0, net19 = 0;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const foodCategories = ['getrÃ¤nke', 'snacks', 'obst', 'gemÃ¼se', 'milch', 'brot', 'back', 'fleisch', 'wurst', 'tiefkÃ¼hl'];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order.items.forEach(item => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const lineTotal = item.price * item.quantity;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const isFood = foodCategories.some(fc => (item.category_name || '').toLowerCase().includes(fc));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const netAmount = lineTotal / (1 + (isFood ? 7 : 19) / 100);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      if (isFood) { tax7 += lineTotal - netAmount; net7 += netAmount; }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      else { tax19 += lineTotal - netAmount; net19 += netAmount; }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const deliveryNet = order.delivery_fee / 1.19;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    tax19 += order.delivery_fee - deliveryNet;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    net19 += deliveryNet;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order.invoice_number = invoiceNumber;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    order.invoice_date = new Date().toISOString();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const pdfBuffer = await generateInvoice(order, business);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const invoicesDir = path.join(__dirname, 'invoices');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!fs.existsSync(invoicesDir)) fs.mkdirSync(invoicesDir, { recursive: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const pdfPath = path.join(invoicesDir, `${invoiceNumber}.pdf`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    fs.writeFileSync(pdfPath, pdfBuffer);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO invoices (order_id, invoice_number, net_total, tax_7_amount, tax_19_amount, gross_total, pdf_path)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(orderId, invoiceNumber, net7 + net19, tax7, tax19, order.total, pdfPath);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log(`Invoice ${invoiceNumber} generated for order ${orderId}`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Auto invoice generation error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ PROMO CODES ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Validate promo code
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/promo/validate', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { code, subtotal } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const promo = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT * FROM promo_codes 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE code = ? AND active = 1
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    AND (valid_from IS NULL OR valid_from <= datetime('now'))
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    AND (valid_until IS NULL OR valid_until >= datetime('now'))
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    AND (max_uses IS NULL OR used_count < max_uses)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(code.toUpperCase());
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!promo) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'UngÃ¼ltiger oder abgelaufener Promo-Code' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check if user already used this code
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const alreadyUsed = db.prepare('SELECT id FROM promo_usage WHERE promo_id = ? AND user_id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .get(promo.id, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (alreadyUsed) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Du hast diesen Code bereits verwendet' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check minimum order value
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (subtotal < promo.min_order_value) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      error: `Mindestbestellwert: ${promo.min_order_value.toFixed(2)} â‚¬ (aktuell: ${subtotal.toFixed(2)} â‚¬)` 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Calculate discount
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let discount = 0;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (promo.discount_type === 'percent') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    discount = subtotal * (promo.discount_value / 100);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else if (promo.discount_type === 'fixed') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    discount = Math.min(promo.discount_value, subtotal);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else if (promo.discount_type === 'delivery') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    discount = 2.99; // Free delivery
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    valid: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    promo: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      id: promo.id,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      code: promo.code,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      description: promo.description,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      discount_type: promo.discount_type,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      discount_value: promo.discount_value,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      discount_amount: discount
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Apply promo code to order (internal use)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

function applyPromoCode(promoId, userId, orderId, discountAmount) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('INSERT INTO promo_usage (promo_id, user_id, order_id, discount_amount) VALUES (?, ?, ?, ?)')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run(promoId, userId, orderId, discountAmount);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('UPDATE promo_codes SET used_count = used_count + 1 WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .run(promoId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin: List all promo codes
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/promo', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const promos = db.prepare('SELECT * FROM promo_codes ORDER BY created_at DESC').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(promos);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin: Create promo code
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/promo', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { code, description, discount_type, discount_value, min_order_value, max_uses, valid_from, valid_until } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const stmt = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO promo_codes (code, description, discount_type, discount_value, min_order_value, max_uses, valid_from, valid_until)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = stmt.run(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      code.toUpperCase(), 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      description, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      discount_type || 'percent', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      discount_value, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      min_order_value || 0, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      max_uses || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      valid_from || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      valid_until || null
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ id: result.lastInsertRowid, code: code.toUpperCase() });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(400).json({ error: 'Code existiert bereits' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin: Update promo code
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.put('/api/admin/promo/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { description, discount_type, discount_value, min_order_value, max_uses, valid_from, valid_until, active } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    UPDATE promo_codes SET description=?, discount_type=?, discount_value=?, min_order_value=?, max_uses=?, valid_from=?, valid_until=?, active=?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).run(description, discount_type, discount_value, min_order_value, max_uses, valid_from, valid_until, active ? 1 : 0, req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin: Delete promo code
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.delete('/api/admin/promo/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('DELETE FROM promo_codes WHERE id = ?').run(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ RATINGS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Submit rating for an order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/orders/:id/rating', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log("ðŸ“¦ Order request:", JSON.stringify(req.body));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { rating, comment } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const orderId = parseInt(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Validate rating
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!rating || rating < 1 || rating > 5) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Bewertung muss zwischen 1 und 5 sein' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const order = db.prepare('SELECT * FROM orders WHERE id = ? AND user_id = ?').get(orderId, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!order) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(404).json({ error: 'Bestellung nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (order.status !== 'delivered') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Nur gelieferte Bestellungen kÃ¶nnen bewertet werden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!order.driver_id) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Kein Fahrer zugewiesen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check if already rated
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const existingRating = db.prepare('SELECT id FROM ratings WHERE order_id = ?').get(orderId);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (existingRating) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Diese Bestellung wurde bereits bewertet' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Insert rating
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stmt = db.prepare('INSERT INTO ratings (order_id, user_id, driver_id, rating, comment) VALUES (?, ?, ?, ?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const result = stmt.run(orderId, req.user.id, order.driver_id, rating, comment || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id: result.lastInsertRowid, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    rating, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    message: 'Danke fÃ¼r deine Bewertung!' 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get rating for an order
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/orders/:id/rating', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const rating = db.prepare('SELECT * FROM ratings WHERE order_id = ?').get(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(rating || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get driver's average rating
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/drivers/:id/rating', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const stats = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      AVG(rating) as average,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      COUNT(*) as count,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SUM(CASE WHEN rating = 5 THEN 1 ELSE 0 END) as five_star,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SUM(CASE WHEN rating = 4 THEN 1 ELSE 0 END) as four_star,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SUM(CASE WHEN rating = 3 THEN 1 ELSE 0 END) as three_star,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SUM(CASE WHEN rating = 2 THEN 1 ELSE 0 END) as two_star,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SUM(CASE WHEN rating = 1 THEN 1 ELSE 0 END) as one_star
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM ratings WHERE driver_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).get(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    average: stats.average ? Math.round(stats.average * 10) / 10 : 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    count: stats.count || 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    distribution: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      5: stats.five_star || 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      4: stats.four_star || 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      3: stats.three_star || 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      2: stats.two_star || 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      1: stats.one_star || 0
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ PUSH NOTIFICATIONS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Save push subscription
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/push/subscribe', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { endpoint, keys } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!endpoint || !keys?.p256dh || !keys?.auth) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'UngÃ¼ltige Subscription' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT OR REPLACE INTO push_subscriptions (user_id, endpoint, p256dh, auth)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(req.user.id, endpoint, keys.p256dh, keys.auth);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Speichern' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Unsubscribe
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.delete('/api/push/unsubscribe', auth(), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  db.prepare('DELETE FROM push_subscriptions WHERE user_id = ?').run(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Send push notification (internal helper)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

async function sendPushNotification(userId, title, body, data = {}) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // This would use web-push library in production
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // For now, we'll use socket.io as fallback
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  io.emit(`notification-${userId}`, { title, body, data });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ AI BARCODE SCANNING ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// AI Vision barcode recognition using OpenAI GPT-4o
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/ai/scan-barcode', async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { image } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!image) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Kein Bild Ã¼bermittelt' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!OPENAI_API_KEY) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('OPENAI_API_KEY not configured');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(500).json({ error: 'OpenAI API nicht konfiguriert' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log('AI Barcode scan request received, image size:', Math.round(image.length / 1024), 'KB');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      method: 'POST',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      headers: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        'Authorization': `Bearer ${OPENAI_API_KEY}`,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        'Content-Type': 'application/json',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      body: JSON.stringify({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        model: 'gpt-4o',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        messages: [
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            role: 'system',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            content: 'You are a barcode reading expert. Your job is to find and read barcode numbers from product images. Look carefully at the image for any barcode - it could be on packaging, labels, cans, bottles, or boxes. Barcodes are vertical black and white lines with numbers printed below them.'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            role: 'user',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            content: [
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                type: 'text',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                text: 'Please find the barcode in this image and tell me the number. Look for:\n- EAN-13 (13 digits, common in Europe)\n- EAN-8 (8 digits)\n- UPC-A (12 digits, common in USA)\n- Any product barcode with vertical lines\n\nThe barcode might be on a can, bottle, box, or any product packaging. Look at the entire image carefully.\n\nRespond with ONLY the barcode number (digits only). If you cannot find or read any barcode, respond with exactly: NONE'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                type: 'image_url',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                image_url: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                  url: image,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                  detail: 'high'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            ]
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        ],
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        max_tokens: 100,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        temperature: 0
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      })
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const data = await response.json();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (data.error) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.error('OpenAI API error:', data.error);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ barcode: null, error: data.error.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = data.choices?.[0]?.message?.content?.trim();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('AI barcode raw result:', result);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Check if result is exactly NONE
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!result || result === 'NONE' || result.toLowerCase().includes('cannot') || result.toLowerCase().includes('unable')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('AI could not find barcode');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ barcode: null });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Extract digits from result (barcode should be 8-14 digits)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const digits = result.replace(/\D/g, '');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('AI extracted digits:', digits);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (digits.length >= 8 && digits.length <= 14) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('âœ… AI found valid barcode:', digits);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ barcode: digits });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Try to find a barcode pattern in the response
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const barcodeMatch = result.match(/\b\d{8,14}\b/);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (barcodeMatch) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('âœ… AI found barcode in text:', barcodeMatch[0]);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ barcode: barcodeMatch[0] });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('No valid barcode found in AI response');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.json({ barcode: null });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('AI scan error:', err);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(500).json({ error: 'AI-Analyse fehlgeschlagen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// AI Product identification from image (when barcode lookup fails)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/ai/identify-product', async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { image, barcode } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!image) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Kein Bild Ã¼bermittelt' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!OPENAI_API_KEY) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.json({ product: null });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log('AI product identification for barcode:', barcode);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      method: 'POST',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      headers: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        'Authorization': `Bearer ${OPENAI_API_KEY}`,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        'Content-Type': 'application/json',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      body: JSON.stringify({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        model: 'gpt-4o',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        messages: [
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            role: 'system',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            content: 'You are a product identification expert. Analyze product images and provide detailed product information in JSON format.'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            role: 'user',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            content: [
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                type: 'text',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                text: `Identify this product from the image. The barcode is: ${barcode || 'unknown'}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

Please analyze the image and return a JSON object with these fields:
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

{
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  "name": "Product name in German",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  "brand": "Brand name",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  "category": "One of: GetrÃ¤nke, Snacks, SÃ¼ÃŸigkeiten, Obst & GemÃ¼se, Milchprodukte, TiefkÃ¼hl, Haushalt, Pflege, Tabak, Alkohol, Sonstiges",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  "description": "Short description in German",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  "quantity_info": "Size/weight if visible (e.g. 500ml, 250g, 20 StÃ¼ck)",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  "estimated_price": "Estimated price in EUR if you can guess, or null"
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

Return ONLY the JSON object, no other text.`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                type: 'image_url',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                image_url: {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                  url: image,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                  detail: 'high'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            ]
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        ],
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        max_tokens: 500,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        temperature: 0.3
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      })
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const data = await response.json();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (data.error) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.error('OpenAI error:', data.error);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ product: null });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = data.choices?.[0]?.message?.content?.trim();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('AI product identification result:', result);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      // Parse JSON from response (handle markdown code blocks)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      let jsonStr = result;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      if (result.includes('```')) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        jsonStr = result.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const product = JSON.parse(jsonStr);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ product, source: 'AI Vision' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } catch (parseErr) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.error('Failed to parse AI response:', parseErr);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({ product: null });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('AI identify error:', err);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.json({ product: null });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ INVENTORY / WAREHOUSE MANAGEMENT ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get all inventory items
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/inventory', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT i.*, p.name as product_name 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM inventory i 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LEFT JOIN products p ON i.product_id = p.id 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY i.name ASC
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(items);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get inventory item by barcode
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/inventory/barcode/:barcode', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const item = db.prepare('SELECT * FROM inventory WHERE barcode = ?').get(req.params.barcode);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(item || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Add inventory item (from barcode scan)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/inventory/add', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { barcode, name, brand, category, price, image, quantity, source } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!name) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Produktname erforderlich' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Check if barcode already exists
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (barcode) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const existing = db.prepare('SELECT * FROM inventory WHERE barcode = ?').get(barcode);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      if (existing) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        // Update stock instead
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        db.prepare('UPDATE inventory SET stock = stock + ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          .run(quantity || 1, existing.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        // Log transaction
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          INSERT INTO inventory_transactions (inventory_id, change_amount, type, user_id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          VALUES (?, ?, 'addition', ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        `).run(existing.id, quantity || 1, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        return res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          id: existing.id, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          updated: true, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          stock: existing.stock + (quantity || 1) 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Map category name to category_id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const categoryMap = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'GetrÃ¤nke': 4,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'Snacks': 5,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'SÃ¼ÃŸigkeiten': 6,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'Obst & GemÃ¼se': 1,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'Milchprodukte': 2,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'TiefkÃ¼hl': 7,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'Haushalt': 9,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'Pflege': 10,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      'Sonstiges': 8
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // First, create product in the shop (products table)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    let productId = null;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const categoryId = categoryMap[category] || 8; // Default to Sonstiges (8)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const productResult = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        INSERT INTO products (category_id, name, description, price, image, unit, unit_amount, stock_count, in_stock)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        VALUES (?, ?, ?, ?, ?, 'StÃ¼ck', '1', ?, 1)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      `).run(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        categoryId,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        brand ? `${brand} ${name}` : name,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        brand ? `${name} von ${brand}` : name,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        price || 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        image || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        quantity || 1
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      productId = productResult.lastInsertRowid;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    } catch (prodErr) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log('Product creation skipped (may already exist):', prodErr.message);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Insert into inventory
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO inventory (barcode, name, brand, category, price, image, stock, source, product_id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      barcode || null, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      name, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      brand || null, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      category || 'Sonstiges',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      price || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      image || null,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      quantity || 1,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      source || 'Manual',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      productId
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Log transaction
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO inventory_transactions (inventory_id, change_amount, type, user_id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, 'initial', ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(result.lastInsertRowid, quantity || 1, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      id: result.lastInsertRowid, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      product_id: productId,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      created: true 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Inventory add error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim HinzufÃ¼gen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Update inventory stock
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.patch('/api/inventory/:id/stock', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { change, reason } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const id = req.params.id;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (typeof change !== 'number') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Ã„nderungswert erforderlich' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const item = db.prepare('SELECT * FROM inventory WHERE id = ?').get(id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!item) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(404).json({ error: 'Produkt nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const newStock = Math.max(0, item.stock + change);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE inventory SET stock = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .run(newStock, id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Log transaction
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO inventory_transactions (inventory_id, change_amount, type, reason, user_id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(id, change, change > 0 ? 'addition' : 'removal', reason || null, req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ id, stock: newStock });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Stock update error:', e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Aktualisieren' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Update inventory item details
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.patch('/api/inventory/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { name, brand, category, price, image, min_stock, barcode } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const id = req.params.id;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      UPDATE inventory 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SET name = COALESCE(?, name),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          brand = COALESCE(?, brand),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          category = COALESCE(?, category),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          price = COALESCE(?, price),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          image = COALESCE(?, image),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          min_stock = COALESCE(?, min_stock),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          barcode = COALESCE(?, barcode),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          updated_at = CURRENT_TIMESTAMP
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(name, brand, category, price, image, min_stock, barcode, id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Aktualisieren' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Delete inventory item
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.delete('/api/inventory/:id', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('DELETE FROM inventory_transactions WHERE inventory_id = ?').run(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('DELETE FROM inventory WHERE id = ?').run(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim LÃ¶schen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get inventory transaction history
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/inventory/:id/history', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const history = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT t.*, u.name as user_name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM inventory_transactions t
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LEFT JOIN users u ON t.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE t.inventory_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY t.created_at DESC
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LIMIT 50
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(history);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get low stock alerts
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/inventory/alerts/low-stock', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT * FROM inventory 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE stock <= min_stock 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY stock ASC
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(items);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Link inventory item to product
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/inventory/:id/link-product', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { product_id } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE inventory SET product_id = ? WHERE id = ?')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .run(product_id, req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim VerknÃ¼pfen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ IMAGE UPLOAD ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const multer = require('multer');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Ensure uploads directory exists
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const uploadsDir = path.join(__dirname, 'uploads');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const productsDir = path.join(uploadsDir, 'products');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

if (!fs.existsSync(uploadsDir)) fs.mkdirSync(uploadsDir, { recursive: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

if (!fs.existsSync(productsDir)) fs.mkdirSync(productsDir, { recursive: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Use memory storage for image processing
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const uploadMemory = multer({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  storage: multer.memoryStorage(),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  limits: { fileSize: 20 * 1024 * 1024 },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  fileFilter: (req, file, cb) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const mimeOk = /image\//.test(file.mimetype);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    cb(null, mimeOk);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Upload product image with automatic optimization
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/upload/product', auth(['admin']), uploadMemory.single('image'), async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!req.file) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Keine Datei hochgeladen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const filename = `product-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.jpg`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const outputPath = path.join(productsDir, filename);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    await sharp(req.file.buffer)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .resize(800, 800, { fit: 'inside', withoutEnlargement: true })
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .jpeg({ quality: 85, progressive: true })
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      .toFile(outputPath);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('ðŸ“¸ Image optimized:', req.file.originalname, '->', filename);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ url: `/uploads/products/${filename}` });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Image processing error:', err);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Bildverarbeitung fehlgeschlagen' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Update product image
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.patch('/api/products/:id/image', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { image } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('UPDATE products SET image = ? WHERE id = ?').run(image, req.params.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Aktualisieren' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ SOCKET.IO ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

io.on('connection', (socket) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log('Client connected:', socket.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  socket.on('join-order', (orderId) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    socket.join(`order-${orderId}`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  socket.on('join-support', (ticketId) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    socket.join(`support-${ticketId}`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  socket.on('disconnect', () => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('Client disconnected:', socket.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ WAITLIST FOR OTHER CITIES ============// Create waitlist tabledb.exec(`  CREATE TABLE IF NOT EXISTS waitlist (    id INTEGER PRIMARY KEY AUTOINCREMENT,    email TEXT NOT NULL,    city TEXT NOT NULL,    postal_code TEXT,    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,    notified INTEGER DEFAULT 0,    UNIQUE(email, city)  )`);// POST /api/waitlist - Join waitlist for a cityapp.post("/api/waitlist", (req, res) => {  const { email, city, postalCode } = req.body;    if (!email || !city) {    return res.status(400).json({ error: "Email und Stadt erforderlich" });  }    try {    db.prepare("INSERT OR IGNORE INTO waitlist (email, city, postal_code) VALUES (?, ?, ?)").run(email, city, postalCode || null);    console.log("ðŸ“ Waitlist signup:", email, "for", city);        // Send welcome email    emailService.sendEmail(email, "Du bist auf der Warteliste! ðŸš€", emailService.waitlistEmail(email, city));        res.json({ success: true, message: "Du wirst benachrichtigt sobald wir in deiner Stadt starten!" });  } catch (e) {    res.status(400).json({ error: "Bereits auf der Warteliste" });  }});// GET /api/admin/waitlist - Admin: See waitlistapp.get("/api/admin/waitlist", auth(["admin"]), (req, res) => {  const waitlist = db.prepare("SELECT * FROM waitlist ORDER BY created_at DESC").all();  res.json(waitlist);});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Catch-all for SPA
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ SHOP STATUS & Ã–FFNUNGSZEITEN ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Shop status cache (in-memory for fast access)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

let shopStatus = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  manuallyOpen: null, // null = use schedule, true = force open, false = force closed
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  openingTime: '08:00',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  closingTime: '22:00',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  timezone: 'Europe/Berlin'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Load shop status from settings on startup
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const savedSettings = db.prepare("SELECT * FROM settings WHERE key IN ('shop_manually_open', 'opening_time', 'closing_time')").all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  savedSettings.forEach(s => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (s.key === 'shop_manually_open') shopStatus.manuallyOpen = s.value === 'true' ? true : s.value === 'false' ? false : null;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (s.key === 'opening_time') shopStatus.openingTime = s.value;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (s.key === 'closing_time') shopStatus.closingTime = s.value;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

} catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log('Shop status defaults used');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Helper: Check if shop is currently open
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

function isShopOpen() {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Manual override takes priority
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (shopStatus.manuallyOpen === true) return { open: true, reason: 'manual', message: 'Manuell geÃ¶ffnet' };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (shopStatus.manuallyOpen === false) return { open: false, reason: 'manual', message: 'Aktuell geschlossen' };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check schedule
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const now = new Date();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const berlinTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Berlin' }));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const currentHours = berlinTime.getHours();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const currentMinutes = berlinTime.getMinutes();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const currentTime = currentHours * 60 + currentMinutes;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const [openH, openM] = shopStatus.openingTime.split(':').map(Number);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const [closeH, closeM] = shopStatus.closingTime.split(':').map(Number);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const openTime = openH * 60 + openM;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const closeTime = closeH * 60 + closeM;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (currentTime >= openTime && currentTime < closeTime) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return { open: true, reason: 'schedule', message: 'GeÃ¶ffnet' };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  return { 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    open: false, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    reason: 'schedule', 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    message: `Geschlossen Â· Ã–ffnet um ${shopStatus.openingTime} Uhr`,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    nextOpen: shopStatus.openingTime
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// GET /api/shop/status - Public endpoint
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/shop/status', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const status = isShopOpen();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ...status,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    openingTime: shopStatus.openingTime,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    closingTime: shopStatus.closingTime,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    manualOverride: shopStatus.manuallyOpen,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    currentTime: new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' })
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// POST /api/admin/shop/toggle - Admin toggle
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/shop/toggle', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { action } = req.body; // 'open', 'close', 'auto'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (action === 'open') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    shopStatus.manuallyOpen = true;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare("INSERT OR REPLACE INTO settings (key, value) VALUES ('shop_manually_open', 'true')").run();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else if (action === 'close') {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    shopStatus.manuallyOpen = false;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare("INSERT OR REPLACE INTO settings (key, value) VALUES ('shop_manually_open', 'false')").run();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } else {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    shopStatus.manuallyOpen = null;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare("DELETE FROM settings WHERE key = 'shop_manually_open'").run();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const status = isShopOpen();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log('ðŸª Shop status changed:', action, status);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ success: true, ...status });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// PUT /api/admin/shop/hours - Update opening hours
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.put('/api/admin/shop/hours', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { openingTime, closingTime } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (openingTime) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    shopStatus.openingTime = openingTime;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare("INSERT OR REPLACE INTO settings (key, value) VALUES ('opening_time', ?)").run(openingTime);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (closingTime) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    shopStatus.closingTime = closingTime;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare("INSERT OR REPLACE INTO settings (key, value) VALUES ('closing_time', ?)").run(closingTime);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    success: true, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    openingTime: shopStatus.openingTime, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    closingTime: shopStatus.closingTime 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ WAITLIST FOR OTHER CITIES ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Create waitlist table
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

db.exec(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  CREATE TABLE IF NOT EXISTS waitlist (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    id INTEGER PRIMARY KEY AUTOINCREMENT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    email TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    city TEXT NOT NULL,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    postal_code TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    notified INTEGER DEFAULT 0,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    UNIQUE(email, city)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  )
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// POST /api/waitlist - Join waitlist for a city
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/waitlist', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { email, city, postalCode } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!email || !city) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: 'Email und Stadt erforderlich' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    db.prepare('INSERT OR IGNORE INTO waitlist (email, city, postal_code) VALUES (?, ?, ?)').run(email, city, postalCode || null);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.log('ðŸ“ Waitlist signup:', email, 'for', city);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Send welcome email (async, don't wait)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    emailService.sendEmail(email, 'Du bist auf der Warteliste! ðŸš€', emailService.waitlistEmail(email, city)).catch(() => {});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true, message: 'Du wirst benachrichtigt sobald wir in deiner Stadt starten!' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(400).json({ error: 'Bereits auf der Warteliste' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// GET /api/admin/waitlist - Admin: See waitlist
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/waitlist', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const waitlist = db.prepare('SELECT * FROM waitlist ORDER BY created_at DESC').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(waitlist);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// SHOP SETTINGS (Mindestbestellwert, LiefergebÃ¼hren)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Initialize shop_settings table (better-sqlite3 syntax)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

db.exec(`CREATE TABLE IF NOT EXISTS shop_settings (
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  key TEXT PRIMARY KEY,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  value TEXT,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

)`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Default settings
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const defaultSettings = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  min_order_value: '15.00',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  delivery_fee: '2.99',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  free_delivery_threshold: '30.00',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  delivery_radius_km: '5'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const insertSettingStmt = db.prepare('INSERT OR IGNORE INTO shop_settings (key, value) VALUES (?, ?)');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

Object.entries(defaultSettings).forEach(([key, value]) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  insertSettingStmt.run(key, value);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get shop settings (public)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/shop/settings', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const rows = db.prepare('SELECT key, value FROM shop_settings').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const settings = {};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    rows.forEach(row => settings[row.key] = row.value);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json(settings);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: err.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ORDER TRACKING (Public)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/track/:orderNumber', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const rawInput = req.params.orderNumber.trim();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const numOnly = rawInput.replace(/^(SPT-|SPEETI-)/i, '').replace(/^0+/, '');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const paddedNum = numOnly.padStart(5, '0');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const sptFormat = 'SPT-' + paddedNum;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const { token, email } = req.query;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        o.id, o.order_number, o.track_token, o.status, o.total, o.delivery_fee, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        o.created_at, o.scheduled_time,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        a.street, a.house_number, a.postal_code as plz, a.city,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        u.name as customer_name, u.email as customer_email
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM orders o
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      LEFT JOIN users u ON o.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      LEFT JOIN addresses a ON o.address_id = a.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE o.id = ? OR o.order_number = ? OR o.order_number = ? OR o.order_number LIKE ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      LIMIT 1
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).get(numOnly, rawInput, sptFormat, '%' + numOnly);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!order) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(404).json({ error: 'Bestellung nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Security: require token OR matching email
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const isValidToken = token && order.track_token && token === order.track_token;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const isValidEmail = email && order.customer_email && 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                         email.toLowerCase() === order.customer_email.toLowerCase();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!isValidToken && !isValidEmail) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.json({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        orderNumber: order.order_number,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        requiresVerification: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        message: 'Bitte gib deine E-Mail-Adresse ein, um die Bestellung zu verifizieren.'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const items = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT oi.quantity, oi.price, p.name, p.image
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM order_items oi
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      LEFT JOIN products p ON oi.product_id = p.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE oi.order_id = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).all(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const statusTimeline = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      pending: { step: 1, label: 'Bestellung eingegangen', icon: 'ðŸ“‹' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      confirmed: { step: 2, label: 'Bestellung bestÃ¤tigt', icon: 'âœ…' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      preparing: { step: 3, label: 'Wird vorbereitet', icon: 'ðŸ‘¨ðŸ³' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      ready: { step: 4, label: 'Bereit zur Auslieferung', icon: 'ðŸ“¦' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      delivering: { step: 5, label: 'Auf dem Weg', icon: 'ðŸš´' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      delivered: { step: 6, label: 'Geliefert', icon: 'ðŸŽ‰' },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      cancelled: { step: 0, label: 'Storniert', icon: 'âŒ' }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const currentStatus = statusTimeline[order.status] || statusTimeline.pending;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      verified: true,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      orderNumber: order.order_number,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      status: order.status,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      statusInfo: currentStatus,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      total: order.total,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      deliveryFee: order.delivery_fee,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      address: { street: order.street, houseNumber: order.house_number, plz: order.plz, city: order.city },
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      customerName: order.customer_name?.split(' ')[0] || 'Kunde',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      items,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      createdAt: order.created_at,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      scheduledTime: order.scheduled_time,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      timeline: Object.entries(statusTimeline)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        .filter(([key]) => key !== 'cancelled')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        .map(([key, val]) => ({
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          status: key, ...val,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          completed: val.step <= currentStatus.step && order.status !== 'cancelled',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          current: key === order.status
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        }))
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error('Track error:', err);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: 'Fehler beim Laden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ADMIN SETTINGS (Full settings management)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get all admin settings
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/admin/settings', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const rows = db.prepare('SELECT key, value FROM shop_settings').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const settings = {};
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    rows.forEach(row => settings[row.key] = row.value);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json(settings);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: err.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Save admin settings (bulk)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post('/api/admin/settings', auth(['admin']), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const settings = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const stmt = db.prepare('INSERT OR REPLACE INTO shop_settings (key, value, updated_at) VALUES (?, ?, datetime("now"))');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Map frontend keys to backend keys
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const keyMap = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      deliveryFee: 'delivery_fee',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      freeDeliveryMin: 'free_delivery_threshold',
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      minOrder: 'min_order_value'
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    Object.entries(settings).forEach(([key, value]) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const dbKey = keyMap[key] || key;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      stmt.run(dbKey, String(value));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (err) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: err.message });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Catch-all for SPA
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ DYNAMIC SITEMAP ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/sitemap.xml', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const baseUrl = 'https://speeti.de';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const today = new Date().toISOString().split('T')[0];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get all categories with products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const categories = db.prepare('SELECT slug FROM categories WHERE id IN (SELECT DISTINCT category_id FROM products WHERE in_stock = 1)').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get all visible products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const products = db.prepare('SELECT id, slug, created_at FROM products WHERE in_stock = 1 AND (visible = 1 OR visible IS NULL)').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Homepage
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += `  <url>\n    <loc>${baseUrl}/</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>daily</changefreq>\n    <priority>1.0</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Search
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += `  <url>\n    <loc>${baseUrl}/search</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>daily</changefreq>\n    <priority>0.9</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Categories
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  categories.forEach(cat => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    xml += `  <url>\n    <loc>${baseUrl}/category/${cat.slug}</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>daily</changefreq>\n    <priority>0.8</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  products.forEach(p => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const lastmod = p.created_at ? p.created_at.split(' ')[0] : today;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    xml += `  <url>\n    <loc>${baseUrl}/produkt/${p.slug || p.id}</loc>\n    <lastmod>${lastmod}</lastmod>\n    <changefreq>weekly</changefreq>\n    <priority>0.7</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Static pages
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  ['impressum', 'datenschutz', 'agb', 'support', 'track'].forEach(page => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    xml += `  <url>\n    <loc>${baseUrl}/${page}</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>monthly</changefreq>\n    <priority>0.5</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += '</urlset>';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.header('Content-Type', 'application/xml');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.send(xml);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ DYNAMIC SITEMAP ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/sitemap.xml', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const baseUrl = 'https://speeti.de';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const today = new Date().toISOString().split('T')[0];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get all categories with products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const categories = db.prepare('SELECT slug FROM categories WHERE id IN (SELECT DISTINCT category_id FROM products WHERE in_stock = 1)').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Get all visible products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const products = db.prepare('SELECT id, slug, created_at FROM products WHERE in_stock = 1 AND (visible = 1 OR visible IS NULL)').all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Homepage
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += `  <url>\n    <loc>${baseUrl}/</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>daily</changefreq>\n    <priority>1.0</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Search
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += `  <url>\n    <loc>${baseUrl}/search</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>daily</changefreq>\n    <priority>0.9</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Categories
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  categories.forEach(cat => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    xml += `  <url>\n    <loc>${baseUrl}/category/${cat.slug}</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>daily</changefreq>\n    <priority>0.8</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Products
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  products.forEach(p => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const lastmod = p.created_at ? p.created_at.split(' ')[0] : today;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    xml += `  <url>\n    <loc>${baseUrl}/produkt/${p.slug || p.id}</loc>\n    <lastmod>${lastmod}</lastmod>\n    <changefreq>weekly</changefreq>\n    <priority>0.7</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Static pages
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  ['impressum', 'datenschutz', 'agb', 'support', 'track'].forEach(page => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    xml += `  <url>\n    <loc>${baseUrl}/${page}</loc>\n    <lastmod>${today}</lastmod>\n    <changefreq>monthly</changefreq>\n    <priority>0.5</priority>\n  </url>\n`;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  xml += '</urlset>';
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.header('Content-Type', 'application/xml');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.send(xml);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ SEO HELPERS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

function generateSlug(name, id) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const base = name.toLowerCase()
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .replace(/Ã¤/g, 'ae').replace(/Ã¶/g, 'oe').replace(/Ã¼/g, 'ue').replace(/ÃŸ/g, 'ss')
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    .replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  return base + '-' + id;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

}
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get product by slug (SEO-friendly URL)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get('/api/products/slug/:slug', (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const product = db.prepare('SELECT p.*, c.name as category_name, c.slug as category_slug FROM products p JOIN categories c ON p.category_id = c.id WHERE p.slug = ?').get(req.params.slug);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!product) return res.status(404).json({ error: 'Produkt nicht gefunden' });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(product);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ REVIEWS ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Submit a review (public, uses order token for auth)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post("/api/reviews", async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const { order_number, token, order_rating, order_comment, driver_rating, driver_comment } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!order_number || !token) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(400).json({ error: "Bestellnummer und Token erforderlich" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Find order and verify token
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT o.id, o.user_id, o.driver_id, o.track_token, o.status
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM orders o WHERE o.order_number = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).get(order_number);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (!order || order.track_token !== token) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(403).json({ error: "UngÃ¼ltiger Token" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (order.status !== "delivered") {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(400).json({ error: "Nur zugestellte Bestellungen kÃ¶nnen bewertet werden" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Check if already reviewed
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const existing = db.prepare("SELECT id FROM reviews WHERE order_id = ?").get(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (existing) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      return res.status(400).json({ error: "Diese Bestellung wurde bereits bewertet" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Insert review
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const result = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      INSERT INTO reviews (order_id, user_id, order_rating, order_comment, driver_rating, driver_comment, driver_id)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      VALUES (?, ?, ?, ?, ?, ?, ?)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).run(order.id, order.user_id, order_rating || null, order_comment || null, driver_rating || null, driver_comment || null, order.driver_id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ success: true, id: result.lastInsertRowid, message: "Danke fÃ¼r deine Bewertung! ðŸŒŸ" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error("Review error:", e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.status(500).json({ error: "Fehler beim Speichern" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Get review for an order (public with token)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get("/api/reviews/:orderNumber", (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { token } = req.query;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const order = db.prepare("SELECT id, track_token FROM orders WHERE order_number = ?").get(req.params.orderNumber);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!order || (token && order.track_token !== token)) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(404).json({ error: "Bestellung nicht gefunden" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const review = db.prepare("SELECT * FROM reviews WHERE order_id = ?").get(order.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ review: review || null, canReview: !review });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Admin: Get all reviews
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get("/api/admin/reviews", auth(["admin"]), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const reviews = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT r.*, o.order_number, u.name as customer_name, d.name as driver_name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM reviews r
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LEFT JOIN orders o ON r.order_id = o.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LEFT JOIN users u ON r.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LEFT JOIN users d ON r.driver_id = d.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY r.created_at DESC
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    LIMIT 100
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json(reviews);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Driver: Get own reviews
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get("/api/driver/reviews", auth(["driver"]), (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const reviews = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    SELECT r.driver_rating, r.driver_comment, r.created_at, o.order_number
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    FROM reviews r
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    JOIN orders o ON r.order_id = o.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    WHERE r.driver_id = ? AND r.driver_rating IS NOT NULL
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    ORDER BY r.created_at DESC
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  `).all(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const avg = db.prepare("SELECT AVG(driver_rating) as avg FROM reviews WHERE driver_id = ? AND driver_rating IS NOT NULL").get(req.user.id);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ reviews, averageRating: avg?.avg || 0 });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Send tracking link via email (secure - no confirmation if email matches)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post("/api/track/send-link", async (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const { order_number, email } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Normalize order number
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const numOnly = order_number.toString().replace(/^(SPT-|SPEETI-)/i, "").replace(/^0+/, "");
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  const sptFormat = "SPT-" + numOnly.padStart(5, "0");
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  if (!order_number || !email) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    return res.status(400).json({ error: "Bestellnummer und E-Mail erforderlich" });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Always return success (don't reveal if email matches!)
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.json({ 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    success: true, 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    message: "Wenn diese E-Mail-Adresse zu der Bestellung gehÃ¶rt, erhÃ¤ltst du in KÃ¼rze einen Link per E-Mail." 
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  // Check in background and send email if matches
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const order = db.prepare(`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      SELECT o.id, o.order_number, o.track_token, o.status, o.total, u.email as customer_email, u.name
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      FROM orders o
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      JOIN users u ON o.user_id = u.id
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      WHERE o.order_number = ? OR o.id = ? OR o.order_number = ?
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    `).get(order_number, numOnly, sptFormat);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (order && order.customer_email && order.customer_email.toLowerCase() === email.toLowerCase()) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      const trackUrl = "https://speeti.de/track/" + order.order_number + "?token=" + order.track_token;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      await emailService.sendEmail(
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        order.customer_email,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        "ðŸ”— Dein Tracking-Link fÃ¼r Bestellung #" + order.order_number,
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        `<!DOCTYPE html>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <html><head><meta charset="utf-8"></head>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        <body style="font-family:-apple-system,sans-serif;padding:20px;background:#f5f5f5;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          <div style="max-width:500px;margin:0 auto;background:white;border-radius:16px;overflow:hidden;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            <div style="background:linear-gradient(135deg,#ec4899,#f43f5e);padding:30px;text-align:center;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <h1 style="color:white;margin:0;">ðŸ”— Tracking-Link</h1>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            <div style="padding:30px;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <p>Hallo <strong>${order.name || ""}!</strong></p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <p>Du hast einen Tracking-Link fÃ¼r deine Bestellung angefordert:</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <div style="background:#fdf2f8;padding:15px;border-radius:8px;margin:20px 0;text-align:center;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                <p style="margin:0;color:#666;">Bestellnummer</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                <p style="margin:5px 0 0 0;font-size:20px;font-weight:bold;color:#ec4899;">#${order.order_number}</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <div style="text-align:center;margin:30px 0;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                <a href="${trackUrl}" style="display:inline-block;background:#ec4899;color:white;padding:14px 28px;border-radius:12px;text-decoration:none;font-weight:bold;">ðŸ“ Bestellung verfolgen</a>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <p style="color:#666;font-size:13px;background:#f9f9f9;padding:12px;border-radius:8px;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

                ðŸ”’ Dieser Link ist nur fÃ¼r dich bestimmt. Teile ihn nicht mit anderen.
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              </p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            <div style="background:#1f2937;color:#9ca3af;padding:20px;text-align:center;font-size:12px;">
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

              <p style="margin:0;">ðŸš´ Speeti â€¢ Dein Lieferservice in MÃ¼nster</p>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

            </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

          </div>
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

        </body></html>`
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      );
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      console.log("ðŸ“§ Tracking link sent to:", order.customer_email);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error("Error sending tracking link:", e);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.get("*", (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  res.sendFile(path.join(__dirname, "../frontend/dist/index.html"));
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// START SERVER
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ================================================
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

server.listen(PORT, () => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  console.log(`ðŸš€ Speeti Backend running on port ${PORT}`);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// ============ ERROR TRACKING ============
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

// Store frontend errors for debugging
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

const frontendErrors = [];
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

app.post("/api/errors/log", (req, res) => {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  try {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const { message, stack, componentStack, url, userAgent, timestamp } = req.body;
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    const error = {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      id: Date.now(),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      message: message?.substring(0, 500) || "Unknown error",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      stack: stack?.substring(0, 2000) || "",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      componentStack: componentStack?.substring(0, 1000) || "",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      url: url?.substring(0, 200) || "",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      userAgent: userAgent?.substring(0, 200) || "",
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      timestamp: timestamp || new Date().toISOString(),
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

      ip: req.ip
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    };
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Keep last 100 errors in memory
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    frontendErrors.unshift(error);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    if (frontendErrors.length > 100) frontendErrors.pop();
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    // Log to console for PM2 logs
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    console.error("ðŸš¨ FRONTEND ERROR:", error.message, "| URL:", error.url);
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ received: true });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  } catch (e) {
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

    res.json({ received: false });
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

  }
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});

});
// Admin endpoint to view errors
app.get("/api/admin/errors", auth(["admin"]), (req, res) => {
  res.json(frontendErrors);
});

// Clear errors
app.delete("/api/admin/errors", auth(["admin"]), (req, res) => {
  frontendErrors.length = 0;
  res.json({ cleared: true });
});


